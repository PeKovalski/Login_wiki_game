// Login System JavaScript
class LoginSystem {
    constructor() {
        this.elements = {};
        this.isLoggedIn = false;
        this.init();
    }

    // Initialize the login system
    init() {
        this.cacheElements();
        this.bindEvents();
        this.setupAccessibility();
    }

    // Cache DOM elements
    cacheElements() {
        this.elements = {
            form: document.getElementById('loginForm'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            togglePassword: document.getElementById('togglePassword'),
            eyeOpen: document.getElementById('eyeOpen'),
            eyeClosed: document.getElementById('eyeClosed'),
            loginBtn: document.getElementById('loginBtn'),
            loginBtnText: document.getElementById('loginBtnText'),
            loginSpinner: document.getElementById('loginSpinner'),
            errorMessage: document.getElementById('errorMessage'),
            successMessage: document.getElementById('successMessage')
        };
    }

    // Bind event listeners
    bindEvents() {
        // Form submission
        if (this.elements.form) {
            this.elements.form.addEventListener('submit', (e) => this.handleLogin(e));
        }

        // Password toggle
        if (this.elements.togglePassword) {
            this.elements.togglePassword.addEventListener('click', () => this.togglePasswordVisibility());
        }

        // Input validation on keyup
        if (this.elements.usernameInput) {
            this.elements.usernameInput.addEventListener('input', () => this.validateInput());
        }

        if (this.elements.passwordInput) {
            this.elements.passwordInput.addEventListener('input', () => this.validateInput());
        }

        // Keyboard accessibility
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));

        // Prevent form resubmission on page refresh
        window.addEventListener('beforeunload', () => this.clearSensitiveData());
    }

    // Setup accessibility features
    setupAccessibility() {
        // Add ARIA labels
        if (this.elements.togglePassword) {
            this.elements.togglePassword.setAttribute('aria-label', 'Alternar visibilidade da senha');
        }

        // Focus management
        if (this.elements.usernameInput) {
            this.elements.usernameInput.focus();
        }
    }

    // Handle form submission
    async handleLogin(event) {
        event.preventDefault();
        
        const username = this.elements.usernameInput?.value.trim();
        const password = this.elements.passwordInput?.value;

        // Clear previous errors
        this.hideError();

        // Validate inputs
        if (!this.validateCredentials(username, password)) {
            return;
        }

        // Set loading state
        this.setLoadingState(true);

        try {
            // Simulate authentication delay
            await this.simulateAuthRequest();
            
            // Check credentials
            if (this.authenticate(username, password)) {
                await this.handleLoginSuccess();
            } else {
                this.handleLoginError('Usuário ou senha incorretos');
            }
        } catch (error) {
            this.handleLoginError('Erro de conexão. Tente novamente.');
            console.error('Login error:', error);
        } finally {
            this.setLoadingState(false);
        }
    }

    // Validate credentials format
    validateCredentials(username, password) {
        if (!username) {
            this.showError('Por favor, digite seu usuário');
            this.elements.usernameInput?.focus();
            return false;
        }

        if (!password) {
            this.showError('Por favor, digite sua senha');
            this.elements.passwordInput?.focus();
            return false;
        }

        if (username.length < 3) {
            this.showError('Usuário deve ter pelo menos 3 caracteres');
            this.elements.usernameInput?.focus();
            return false;
        }

        if (password.length < 6) {
            this.showError('Senha deve ter pelo menos 6 caracteres');
            this.elements.passwordInput?.focus();
            return false;
        }

        return true;
    }

    // Authenticate user (hardcoded for demo)
    authenticate(username, password) {
        // In a real application, this would make an API call
        const validCredentials = {
            username: 'antonio',
            password: 'bonitao'
        };

        return username.toLowerCase() === validCredentials.username.toLowerCase() && 
               password === validCredentials.password;
    }

    // Simulate authentication request
    async simulateAuthRequest() {
        return new Promise((resolve) => {
            setTimeout(resolve, 1000 + Math.random() * 1000); // 1-2 seconds
        });
    }

    // Handle successful login
    async handleLoginSuccess() {
        this.isLoggedIn = true;
        
        // Show success message
        this.showSuccess();
        
        // Store login state (in real app, use secure tokens)
        this.storeLoginState();
        
        // Redirect after delay (in real app, redirect to main page)
        setTimeout(() => {
            console.log('Login successful! Redirecting...');
            // window.location.href = '/dashboard'; // Example redirect
            alert('Login realizado com sucesso! Em uma aplicação real, você seria redirecionado.');
        }, 2000);
    }

    // Handle login error
    handleLoginError(message) {
        this.showError(message);
        this.shakeForm();
        this.clearPasswordField();
    }

    // Toggle password visibility
    togglePasswordVisibility() {
        if (!this.elements.passwordInput || !this.elements.eyeOpen || !this.elements.eyeClosed) {
            return;
        }

        const isPassword = this.elements.passwordInput.type === 'password';
        
        // Toggle input type
        this.elements.passwordInput.type = isPassword ? 'text' : 'password';
        
        // Toggle icons
        this.elements.eyeOpen.classList.toggle('hidden', !isPassword);
        this.elements.eyeClosed.classList.toggle('hidden', isPassword);
        
        // Update ARIA label
        const label = isPassword ? 'Ocultar senha' : 'Mostrar senha';
        this.elements.togglePassword.setAttribute('aria-label', label);
        
        // Keep focus on password input
        this.elements.passwordInput.focus();
    }

    // Validate input in real-time
    validateInput() {
        const username = this.elements.usernameInput?.value.trim();
        const password = this.elements.passwordInput?.value;
        
        // Enable/disable login button based on input
        const isValid = username && password && username.length >= 3 && password.length >= 6;
        
        if (this.elements.loginBtn) {
            this.elements.loginBtn.disabled = !isValid;
        }
    }

    // Set loading state
    setLoadingState(isLoading) {
        if (!this.elements.loginBtn || !this.elements.loginBtnText || !this.elements.loginSpinner) {
            return;
        }

        if (isLoading) {
            this.elements.loginBtn.disabled = true;
            this.elements.loginBtnText.textContent = 'Verificando...';
            this.elements.loginSpinner.classList.remove('hidden');
        } else {
            this.elements.loginBtn.disabled = false;
            this.elements.loginBtnText.textContent = 'Entrar no Reino Etéreo';
            this.elements.loginSpinner.classList.add('hidden');
        }
    }

    // Show error message
    showError(message) {
        if (!this.elements.errorMessage) return;
        
        this.elements.errorMessage.textContent = message;
        this.elements.errorMessage.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => this.hideError(), 5000);
    }

    // Hide error message
    hideError() {
        if (!this.elements.errorMessage) return;
        
        this.elements.errorMessage.classList.add('hidden');
    }

    // Show success message
    showSuccess() {
        if (!this.elements.successMessage) return;
        
        this.elements.successMessage.classList.remove('hidden');
    }

    // Shake form animation for errors
    shakeForm() {
        if (!this.elements.form) return;
        
        this.elements.form.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
            this.elements.form.style.animation = '';
        }, 500);
    }

    // Clear password field for security
    clearPasswordField() {
        if (this.elements.passwordInput) {
            this.elements.passwordInput.value = '';
        }
    }

    // Clear sensitive data
    clearSensitiveData() {
        if (this.elements.passwordInput) {
            this.elements.passwordInput.value = '';
        }
    }

    // Store login state (demo - use secure methods in production)
    storeLoginState() {
        try {
            const loginData = {
                isLoggedIn: true,
                timestamp: Date.now(),
                // In production, store secure tokens instead
            };
            
            sessionStorage.setItem('loginState', JSON.stringify(loginData));
        } catch (error) {
            console.warn('Could not store login state:', error);
        }
    }

    // Handle keyboard events
    handleKeyboard(event) {
        // ESC key to clear errors
        if (event.key === 'Escape') {
            this.hideError();
        }
        
        // Enter key on toggle password button
        if (event.key === 'Enter' && event.target === this.elements.togglePassword) {
            event.preventDefault();
            this.togglePasswordVisibility();
        }
    }

    // Check if user is already logged in
    static checkExistingLogin() {
        try {
            const loginData = sessionStorage.getItem('loginState');
            if (loginData) {
                const parsed = JSON.parse(loginData);
                const now = Date.now();
                const sessionDuration = 24 * 60 * 60 * 1000; // 24 hours
                
                if (parsed.isLoggedIn && (now - parsed.timestamp) < sessionDuration) {
                    return true;
                }
            }
        } catch (error) {
            console.warn('Could not check existing login:', error);
        }
        return false;
    }

    // Logout functionality
    static logout() {
        try {
            sessionStorage.removeItem('loginState');
            window.location.reload();
        } catch (error) {
            console.warn('Could not logout:', error);
        }
    }
}

// Utility functions
const LoginUtils = {
    // Debounce function for input validation
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    // Validate email format (if needed)
    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },

    // Generate secure random password (for demo)
    generateSecurePassword(length = 12) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < length; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }
};

// Initialize login system when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    // Check if user is already logged in
    if (LoginSystem.checkExistingLogin()) {
        console.log('User already logged in');
        // In a real app, redirect to dashboard
        // window.location.href = '/dashboard';
        return;
    }

    // Initialize login system
    const loginSystem = new LoginSystem();
    
    // Make it globally accessible for debugging
    window.loginSystem = loginSystem;
    window.LoginUtils = LoginUtils;
    
    console.log('Login system initialized');
});

// Handle page visibility change (security feature)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Page is hidden - could implement auto-logout timer
        console.log('Page hidden');
    } else {
        // Page is visible again
        console.log('Page visible');
    }
});

// Performance monitoring
if ('performance' in window) {
    window.addEventListener('load', () => {
        setTimeout(() => {
            const perfData = performance.getEntriesByType('navigation')[0];
            if (perfData) {
                console.log('Login page load time:', Math.round(perfData.loadEventEnd - perfData.loadEventStart) + 'ms');
            }
        }, 0);
    });
}

// Error handling
window.addEventListener('error', (event) => {
    console.error('JavaScript Error:', event.error);
    // In production, send errors to logging service
});

// Export for module systems (if needed)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { LoginSystem, LoginUtils };
}